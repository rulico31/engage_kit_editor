-- Migration: 05_patch_strict_project_privacy
-- Description: プロジェクトの閲覧権限を厳格化し、ユーザー間の分離を徹底する
-- Created: 2026-01-10

-- ------------------------------------------------------------------------------
-- 1. Projectsテーブルの閲覧権限ポリシーを修正
-- ------------------------------------------------------------------------------
-- 既存の「誰でも見れる」ポリシーを削除
DROP POLICY IF EXISTS "Public can view projects" ON projects;

-- 新しいポリシー: 「自分のもの OR 公開済み」のみ閲覧可能
-- ※ is_published = true はWebViewerなどで公開ページを見るために必要
CREATE POLICY "Users can view own or published projects" 
ON projects FOR SELECT 
USING (
  (auth.uid() = user_id) 
  OR 
  (is_published = true)
);

-- ------------------------------------------------------------------------------
-- 2. 注意: 既存の「孤立した」プロジェクトについて
-- ------------------------------------------------------------------------------
-- 以前作成した user_id が NULL の古いプロジェクトは、このポリシー適用後
-- 所有者も誰でもないため、一覧から見えなくなります（意図通りの挙動です）。
-- テストデータとして消えて良いものと判断して進めてください。
